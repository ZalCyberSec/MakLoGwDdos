<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PRIMROSEX TECH - Login</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500,700&family=Poppins:wght@300,400,600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --purple-1: #6b21a8;
  --purple-2: #8b5cf6;
  --accent: #8b5cf6;
  --glass: rgba(255,255,255,0.04);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',sans-serif;
  background: linear-gradient(180deg,#0f172a 0%, #0b1220 100%);
  color:#e6e6f0;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#particles{position:fixed;inset:0;z-index:0;pointer-events:none;background:transparent;}
.container{
  position:relative;z-index:2;width:auto;max-width:680px;margin:20px;padding:24px;border-radius:20px;
  background:var(--glass);backdrop-filter:blur(6px) saturate(120%);
  box-shadow:0 10px 35px rgba(11,12,30,0.6);text-align:center;
  border:1px solid rgba(139,92,246,0.06);
}
.container::before{
  content:"";
  position:absolute;
  width:200%;
  height:200%;
  left:-50%;
  top:-50%;
  opacity:.04;
  background:conic-gradient(from 0deg,var(--purple-1),var(--purple-2),var(--purple-1));
  animation:spin 16s linear infinite;
  border-radius:30%;
  pointer-events:none; /* ← BIAR GA NUTUP TOMBOL */
}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg);} }
.media video{width:100%;border-radius:12px;}
.brand{
  font-family:'Orbitron',sans-serif;font-size:24px;color:var(--purple-2);margin-top:12px;font-weight:700;
  letter-spacing:1px;text-shadow:0 6px 18px rgba(139,92,246,0.08);
}
.input-row{display:flex;align-items:center;gap:12px;margin:12px 0;}
.left-icon{width:36px;display:flex;justify-content:center;color:var(--purple-2);font-size:16px;}
.left-label{flex:0 0 110px;text-align:left;color:var(--accent);font-weight:700;font-size:14px;white-space:nowrap;transition:.14s;}
.left-label.hidden{opacity:0;transform:translateX(-6px);}
.field-wrap{position:relative;flex:1;}
input[type="text"],input[type="password"]{
  width:100%;padding:12px 40px 12px 12px;border-radius:12px;background:rgba(14,8,23,0.32);
  border:1px solid rgba(139,92,246,0.12);color:#eae6ff;font-size:15px;outline:none;
}
input::placeholder{color:rgba(230,230,240,0.28);}
input:focus{border-color:var(--purple-2);box-shadow:0 6px 20px rgba(139,92,246,0.06);}
.right-icon{position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#e6e6f0;font-size:16px;cursor:pointer;}
.btn{
  width:100%;padding:12px 20px;margin:12px auto;border-radius:10px;
  background:linear-gradient(90deg,var(--purple-1),var(--purple-2));
  color:#fff;font-weight:700;font-size:16px;border:0;cursor:pointer;
  box-shadow:0 8px 24px rgba(107,33,168,0.18);
}
.btn:hover{transform:translateY(-3px);box-shadow:0 14px 40px rgba(107,33,168,0.22);}
.status-line{margin-top:12px;font-size:14px;color:rgba(230,230,240,0.9);min-height:18px;}
.status-line .err{color:var(--accent);font-weight:700;}
.status-line .ok{color:#a7ffb3;font-weight:700;}
.footer{margin-top:16px;display:flex;gap:12px;justify-content:center;}
.footer button{
  display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;
  background:linear-gradient(90deg,var(--purple-1),var(--purple-2));color:#fff;border:0;cursor:pointer;
  font-weight:700;box-shadow:0 8px 24px rgba(107,33,168,0.14);
}
.footer button:hover{transform:translateY(-3px);box-shadow:0 14px 40px rgba(107,33,168,0.22);}
.toast{
  position:fixed;right:18px;top:18px;z-index:9999;background:linear-gradient(180deg,rgba(24,6,36,0.95),rgba(9,3,18,0.9));
  color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.6);
  border-left:4px solid var(--accent);opacity:0;transform:translateY(-8px);transition:.18s;font-weight:600;
}
.toast.show{opacity:1;transform:translateY(0);}
</style>
</head>
<body>
<div id="particles"></div>

<div class="container" id="login">
  <div class="media">
    <video src="https://files.catbox.moe/kl2dh1.mp4" autoplay muted loop playsinline></video>
  </div>
  <h1 class="brand"><i class="fa-solid fa-crown"></i> PRIMROSEX TECH</h1>

  <div class="input-row">
    <div class="left-icon"><i class="fa-solid fa-user"></i></div>
    <div class="field-wrap">
      <input id="username" type="text" placeholder="Username...">
    </div>
  </div>

  <div class="input-row">
    <div class="left-icon"><i class="fa-solid fa-lock"></i></div>
    <div class="field-wrap">
      <input id="password" type="password" placeholder="Password...">
      <div class="right-icon" id="togglePass"><i class="fa-solid fa-eye"></i></div>
    </div>
  </div>

  <button class="btn" id="btnLogin"><i class="fa-solid fa-right-to-bracket"></i> Enter</button>
  <div id="loginStatus" class="status-line">Status: Menunggu</div>

  <div class="footer">
    <button id="btnDeveloper"><i class="fa-brands fa-telegram"></i> Developer</button>
    <button id="btnInfo"><i class="fa-solid fa-info-circle"></i> Information</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jnicol/particleground/jquery.particleground.min.js"></script>
<script>
const BACKEND_URL = "http://malllzpanelprivate.kibiljoe.engineer";
const IP_SERVICE = "https://api.ipify.org?format=json";

function uuidv4(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random()*16|0, v = c=='x'? r : (r&0x3|0x8);
    return v.toString(16);
  });
}
function showToast(msg, ms=2200){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.classList.remove('show'),ms);
}
function getOrCreateDeviceId(){
  let id=localStorage.getItem('prim_deviceId');
  if(!id){id=uuidv4();localStorage.setItem('prim_deviceId',id);}
  return id;
}
function loadDeviceMap(){try{return JSON.parse(localStorage.getItem('prim_deviceUserMap')||'{}');}catch(e){return {};}}
function saveDeviceMap(map){localStorage.setItem('prim_deviceUserMap',JSON.stringify(map));}
function loadUsers(){try{return JSON.parse(localStorage.getItem('prim_users')||'[]');}catch(e){return [];}}
function saveUsers(arr){localStorage.setItem('prim_users',JSON.stringify(arr));}
function upsertLocalUser(userObj){
  const arr=loadUsers();const idx=arr.findIndex(u=>u.username===userObj.username);
  if(idx>=0)arr[idx]=Object.assign(arr[idx],userObj);else arr.push(userObj);
  saveUsers(arr);localStorage.setItem('prim_currentUser',JSON.stringify(userObj));
}
async function fetchPublicIp(){
  try{const r=await fetch(IP_SERVICE,{cache:"no-store"});if(!r.ok)throw new Error('no ip');
    const j=await r.json();return j.ip||'unknown';
  }catch(e){return 'unknown';}
}
async function sendToBackend(path,payload){
  try{
    const res=await fetch(BACKEND_URL+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const json=await res.json().catch(()=>({status:res.status}));
    return {ok:res.ok,status:res.status,body:json};
  }catch(e){return {ok:false,reason:e.message||'network-error'};}
}
function deviceAssignedToDifferentUser(deviceId,username){
  const map=loadDeviceMap();if(!map[deviceId])return false;
  return map[deviceId]!==username;
}
function assignDeviceToUser(deviceId,username){
  const map=loadDeviceMap();map[deviceId]=username;saveDeviceMap(map);
}
function detectRoleFromUsername(username){
  const arr=loadUsers();const found=arr.find(u=>u.username===username);
  if(found&&found.role)return found.role;
  const u=username.toLowerCase();
  if(u.startsWith('reseller'))return'reseller';
  if(u.startsWith('owner'))return'owner';
  if(u==='z'||u.includes('dev'))return'developer';
  return'user';
}

document.addEventListener('DOMContentLoaded',function(){
  try{
    particleground(document.getElementById('particles'),{
      dotColor:'#8b5cf6',lineColor:'#6b21a8',
      minSpeedX:.02,maxSpeedX:.35,minSpeedY:.01,maxSpeedY:.20,density:9000,particleRadius:3,proximity:120
    });
  }catch(e){}
  const username=document.getElementById('username'),
        password=document.getElementById('password'),
        labelUser=document.getElementById('labelUser'),
        labelPass=document.getElementById('labelPass'),
        togglePass=document.getElementById('togglePass'),
        btnLogin=document.getElementById('btnLogin'),
        loginStatus=document.getElementById('loginStatus'),
        btnDev=document.getElementById('btnDeveloper'),
        btnInfo=document.getElementById('btnInfo');

  const initialUsers=[
    {username:'reseller1',role:'reseller'},
    {username:'owner1',role:'owner'},
    {username:'z',role:'developer'},
    {username:'user',role:'user'}
  ];
  if(loadUsers().length===0)saveUsers(initialUsers);
  function updateLabelVisibility(input,label){
    if(input.value.length>0)label.classList.add('hidden');else label.classList.remove('hidden');
  }
  username.addEventListener('input',()=>updateLabelVisibility(username,labelUser));
  password.addEventListener('input',()=>updateLabelVisibility(password,labelPass));
  togglePass.addEventListener('click',()=>{
    const icon=togglePass.querySelector('i');
    if(password.type==='password'){password.type='text';icon.classList.replace('fa-eye','fa-eye-slash');}
    else{password.type='password';icon.classList.replace('fa-eye-slash','fa-eye');}
  });

  const deviceId=getOrCreateDeviceId();
  btnDev.onclick=()=>window.open('https://t.me/Zal_PrimroseX_Tech','_blank');
  btnInfo.onclick=()=>window.open('https://whatsapp.com/channel/0029VbA7iUI1Hsq1P7VS2S3D','_blank');

  btnLogin.addEventListener('click',async()=>{
    const u=username.value.trim(),p=password.value.trim();
    if(!u||!p){loginStatus.innerHTML='Status: <span class="err">Isi Username & Password</span>';showToast('Isi Username & Password!');return;}
    if(deviceAssignedToDifferentUser(deviceId,u)){
      loginStatus.innerHTML='Status: <span class="err">Device ini sudah dipakai oleh username lain!</span>';
      showToast('Device sudah terpakai!');return;
    }
    loginStatus.textContent='Status: Mendapatkan info device...';
    const ip=await fetchPublicIp();const ua=navigator.userAgent||'unknown';const ts=new Date().toISOString();
    const role=detectRoleFromUsername(u);
    const payload={username:u,password:p,role,deviceId,deviceIp:ip,userAgent:ua,timestamp:ts};
    const localUserObj={username:u,role,deviceId,deviceIp:ip,lastLogin:ts};
    upsertLocalUser(localUserObj);assignDeviceToUser(deviceId,u);
    loginStatus.textContent='Status: Mengirim data ke backend...';
    const res=await sendToBackend('/api/login',payload);
    if(res.ok){showToast('Login Berhasil');loginStatus.innerHTML='Status: <span class="ok">Login Berhasil</span>';
      window.location.href='start.html';
    }else{
      showToast('Login lokal OK — backend gagal');loginStatus.innerHTML='Status: <span class="ok">Login Lokal Berhasil</span>';
      window.location.href='start.html';
    }
  });
});
</script>
</body>
</html>